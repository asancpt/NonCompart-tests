---
title: Validation of Noncompartmental Analysis Performed by NonCompart R package 
author: Sungpil Han <shan@acp.kr>
date: "`r Sys.Date()`"
bibliography: ['Test.bib']
output:
  bookdown::pdf_document2: default
  pdf_document: default
  html_document: default
header-includes:
  - \usepackage{textcomp}
---

```{r setup, include = FALSE}
#knitr::write_bib(file='Test.bib')
library(knitr)
library(kableExtra) # devtools::install_github("haozhu233/kableExtra")
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

------

# Introduction

NonCompart R package [@R-NonCompart] can conduct a noncompartmental analysis as closely as possible to the most widely used commercial software for pharmacokinetic analysis, i.e. [Phoenix^®^   WinNonlin^®^](https://www.certara.com/software/pkpd-modeling-and-simulation/phoenix-winnonlin/).
This document provides validation of noncompartmental analysis performed by NonCompart R package as compared to the results from the commercial software.

# Results

This script will be stopped if there is any difference between results from NonCompart and WinNonlin printing `Test Failed!`.

```{r}
# install.packages("NonCompart", repos="http://pmx.amc.seoul.kr")
library(NonCompart)
RptCfg = read.csv("RptCfg.csv", as.is=TRUE)

Equal = function(Wres, Rres, Tol=0.001)
{
  Wres[,"ID"] = as.character(Wres[,"Subject"])
  ColName0 = colnames(Rres)
  rownames(RptCfg) = RptCfg[,"PPTESTCD"]
  colnames(Rres) = c(ColName0[1], RptCfg[ColName0[-1],"WNL"])
  Inter = intersect(colnames(Wres), colnames(Rres))
  
  IsSame = TRUE
  for (i in 1:nrow(Wres)) {
    for (j in Inter) {
      R = as.numeric(Rres[i,j])
      W = as.numeric(Wres[i,j])
      if (W != 0) {
        if(abs((R - W)/W) > Tol) {
          print(Wres[i,j])
          print(Rres[i,j])
          IsSame = FALSE
        }
      }
    }
  }
  return(IsSame)
}
```

Eight comparison tests were performed using `Theoph` and `Indometh` default datasets. Detailed side-by-side comparison is in Appendix [#sidebyside].




"No.,Dataset,Down,Route,File Link
1,Theoph (n=12),Linear,Extravascular,[CSV](https://raw.githubusercontent.com/asancpt/NonCompart-tests/master/Final_Parameters_Pivoted_Theoph_Linear.csv)
2,Theoph (n=12),Log,Extravascular,[CSV](https://raw.githubusercontent.com/asancpt/NonCompart-tests/master/Final_Parameters_Pivoted_Theoph_Log.csv)
3,Indometh (n=6),Linear,IV Bolus,[CSV](https://raw.githubusercontent.com/asancpt/NonCompart-tests/master/Final_Parameters_Pivoted_Indometh_Linear.csv)
4,Indometh (n=6),Log,IV Bolus,[CSV](https://raw.githubusercontent.com/asancpt/NonCompart-tests/master/Final_Parameters_Pivoted_Indometh_Log.csv)
5,Indometh (n=6),Linear,IV Infusion (0.25hr),[CSV](https://raw.githubusercontent.com/asancpt/NonCompart-tests/master/Final_Parameters_Pivoted_Indometh_Linear_Infusion.csv)
6,Indometh (n=6),Log,IV Infusion (0.25hr),[CSV](https://raw.githubusercontent.com/asancpt/NonCompart-tests/master/Final_Parameters_Pivoted_Indometh_Log_Infusion.csv)
7,Indometh (n=6),Linear,Extravascular,[CSV](https://raw.githubusercontent.com/asancpt/NonCompart-tests/master/Final_Parameters_Pivoted_Indometh_Linear_Wrong_Extravascular.csv)
8,Indometh (n=6),Log,Extravascular,[CSV](https://raw.githubusercontent.com/asancpt/NonCompart-tests/master/Final_Parameters_Pivoted_Indometh_Log_Wrong_Extravascular.csv)
"

```{r}
Theoph[,"Subject"] = as.numeric(as.character(Theoph[,"Subject"]))
Indometh[,"Subject"] = as.numeric(as.character(Indometh[,"Subject"]))

Wres1 = read.csv("Final_Parameters_Pivoted_Theoph_Linear.csv")
Rres1 = tblNCA(Theoph, "Subject", "Time", "conc", dose=320, concUnit="mg/L")
if (!Equal(Wres1, Rres1)) stop("Test Failed!")

Wres2 = read.csv("Final_Parameters_Pivoted_Theoph_Log.csv")
Rres2 = tblNCA(Theoph, "Subject", "Time", "conc", dose=320, down="Log", 
              concUnit="mg/L")
if (!Equal(Wres2, Rres2)) stop("Test Failed!")

Wres3 = read.csv("Final_Parameters_Pivoted_Indometh_Linear.csv")
Rres3 = tblNCA(Indometh, "Subject", "time", "conc", dose=25, adm="Bolus", 
              concUnit="mg/L", R2ADJ=0.8)
if (!Equal(Wres3, Rres3)) stop("Test Failed!")

Wres4 = read.csv("Final_Parameters_Pivoted_Indometh_Log.csv")
Rres4 = tblNCA(Indometh, "Subject", "time", "conc", dose=25, adm="Bolus", 
              down="Log", concUnit="mg/L", R2ADJ=0.8)
if (!Equal(Wres4, Rres4)) stop("Test Failed!")

Wres5 = read.csv("Final_Parameters_Pivoted_Indometh_Linear_Infusion.csv")
Rres5 = tblNCA(Indometh, "Subject", "time", "conc", dose=25, adm="Infusion", 
              dur=0.25, concUnit="mg/L", R2ADJ=0.8)
if (!Equal(Wres5, Rres5)) stop("Test Failed!")

Wres6 = read.csv("Final_Parameters_Pivoted_Indometh_Log_Infusion.csv")
Rres6 = tblNCA(Indometh, "Subject", "time", "conc", dose=25, adm="Infusion", 
              dur=0.25, down="Log", concUnit="mg/L", R2ADJ=0.8)
if (!Equal(Wres6, Rres6)) stop("Test Failed!")

Wres7 = read.csv("Final_Parameters_Pivoted_Indometh_Linear_Wrong_Extravascular.csv")
Rres7 = tblNCA(Indometh, "Subject", "time", "conc", dose=25, concUnit="mg/L", 
              R2ADJ=0.8)
if (!Equal(Wres7, Rres7)) stop("Test Failed!")

Wres8 = read.csv("Final_Parameters_Pivoted_Indometh_Log_Wrong_Extravascular.csv")
Rres8 = tblNCA(Indometh, "Subject", "time", "conc", dose=25, down="Log", 
              concUnit="mg/L", R2ADJ=0.8)
if (!Equal(Wres8, Rres8)) stop("Test Failed!")
```

# Conclusion 

Nothing happened and it indicates that **there is no discrepancy**. Noncompartmental analyses generated by NonCompart R package are qualified and validated.

\pagebreak

# (APPENDIX) Appendix {-}

# Side-by-side comparison of results {#sidebyside}

```{r}
library(dplyr)
library(tidyr)

table_wres_rres <- function(wres, rres){
  wres %>% 
    gather(WNL, WinNonlin, -Subject) %>% 
    left_join(RptCfg %>% select(PPTESTCD, WNL), by = "WNL") %>% 
    left_join(rres %>% as.data.frame() %>% gather(PPTESTCD, NonCompart, -Subject),
              by = c("Subject", "PPTESTCD")) %>% 
    select(Subject, PPTESTCD, WNL, NonCompart, WinNonlin) %>% 
    filter(!is.na(WinNonlin) & !is.na(NonCompart)) %>% 
    knitr::kable(longtable = TRUE, booktabs = TRUE, format = "latex", 
                 caption = "Longtable") %>% 
    add_header_above(c(" ", "Parameters" = 2, "Values" = 2)) %>% 
    kable_styling(latex_options = c("repeat_header"))
    
}
```

## Test 1: Theoph (n=12), Linear, Extravascular

```{r}
table_wres_rres(Wres1, Rres1)
```

## Test 2: Theoph (n=12), Log, Extravascular

```{r}
table_wres_rres(Wres2, Rres2)
```

\pagebreak

# Session Information

```{r}
devtools::session_info()
```

\pagebreak

# References {-}
